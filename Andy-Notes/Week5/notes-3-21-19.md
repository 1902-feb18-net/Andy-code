# Notes 3-21-19
- Hungry 2.0 made edit from Hungry to Hangry
	- There is no Cookie
	- The Cookie is a lie
	- Be mad

## Authentication/Authorization
- [info on setting up](https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity-configuration?view=aspnetcore-2.2)
- [more general auth set up](https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity?view=aspnetcore-2.2&tabs=visual-studio)
- Cookie
	- Cookie header which belongs to req
		- every time client sends a request to some URI our browser auto takes those cookies and stores into our cookie header
		- Set-Cookie creates a cookie and set a time for it to expire (e.g. when we login)
	- when we logout, it sets the cookie to empty string, which deletes it
- Since we are in API and use Identity, there will be problems because there will be redirection issues
- Nick's code we have our web api and then he made a new separate project for MVC 
- Make sure to check Nick's code to see what he did later, going light warp speed @-@
- `[browser] <--(Set-Cookie)-- [MVC] <-- (cookie) --> [API]`
	- `[MVC] -- (copy cookie to response) --> [MVC]`
	- `[browser] --(Cookie)--> [MVC]`
	- `[MVC] -- (copy) --> [MVC]`
	- going set cookie going up and get cookie while going down
- **Know how to delete your cookies**
	- go to settings -> Content settings -> Cookies -> go by domain and clear localhost cookies

### Some Cookie Code
```csharp
public HttpRequestMessage CreateRequestToService(HttpMethod method,
	string relativeUrl, object body = null)
{
	var url = new URL(ServiceUrl, relativeUrl);
	var apiRequest = new HttpRequestMessage(method, url);

	if(body != null)
	{
		var jsonString = JsonConvert.SerializeObject(body);
		apiRequest.Content = new StringContent(jsonString, Encoding.UTFS, "application/json");
	}

	// get the value of the app's auth cookie from the browser's req
	// if present and copu it to the api req
	var cookieValue = Request.Cookies[ServiceCookieName];

	if(cookieValue != null)
	{
		var headerValue = new CookieHeaderValue(...)
		// do stuffs
	}
}

// somewhere in the Models we create models for the 

// generate some views based on controllers then edit it a bit, we made a view and create
// make sure to edit nav and etc to point to the correct routes

// remember to register your services in startup.cs
services.AddSingleton<HttpClient>();

// somewhere in controllers folder and some controller class
public class AccountController : AserviceController
{
	public AccountController(HttpClient httpClient, IConfiguration configuration)
		: base(httpClient, configuration)
	{
		// empty
	}

	public IActionResult Login()
	{
		return View();
	}

	[HttpPost]
	public async Task<IActionResult> Login(ApiLogin login)
	{
		if (!ModelState.IsValid)
		{
			return View(login);
		}

		var req = CreateRequestToService(HttpMethod.Post, "/api/account/login", login);
		var res = await HttpClient.SendAsync(req);
		if(!res.IsSuccessStatusCode)
		{
			if(res.StatusCode == HttpStatusCode.Unauthorized)
			{
				// login failed because bad credentials
				ModelState.AddModelError("", "Login or pw incorrect");
				return View();
			}
			ModelState.AddModelError("", "Unexpected server error");
			return View();
		}
		var success = PassCookiesToClient(response)
		if(!success)
		{
			ModelState.AddModelError("", "Unexpected server error");
			return View();
		}
		//login success
		return RedirectToAction("Index", "Home");
	}

	public void PassCookiesToClient(HttpResponseMessage apiResponse)
	{
		// did something fancy combining the if statements together
		if(apiResponse.Headers.TryGetValues("Set-Cookie", out var values))
		{
			// the header value contains both the name and val of the cookie itself
			var headerValue = values.FirstOrDefault( x => x.StartsWith(ServiceCookieName))
			if (headerValue != null)
			{
				// copy that cookie to the res we will send to the client
				Response.Headers.Add("Set-Cookie", headerValue);
				return true;
			}
		}
	}

}
```